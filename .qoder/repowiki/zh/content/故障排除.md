# 故障排除

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [package.json](file://package.json)
- [vite.config.js](file://vite.config.js)
- [Dockerfile](file://Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [src/Fretboard.jsx](file://src/Fretboard.jsx)
- [src/utils/fretboardShare.js](file://src/utils/fretboardShare.js)
- [src/utils/fretboardHistory.js](file://src/utils/fretboardHistory.js)
- [src/hooks/useFretboardState.js](file://src/hooks/useFretboardState.js)
- [src/colorConfig.js](file://src/colorConfig.js)
- [src/components/Toast.jsx](file://src/components/Toast.jsx)
</cite>

## 目录
1. [端口冲突解决方案](#端口冲突解决方案)
2. [依赖安装失败处理](#依赖安装失败处理)
3. [构建错误诊断](#构建错误诊断)
4. [浏览器兼容性问题](#浏览器兼容性问题)
5. [性能优化建议](#性能优化建议)

## 端口冲突解决方案

当开发服务器启动时，默认使用端口 5173。如果该端口已被占用，Vite 会自动尝试下一个可用端口（如 5174、5175 等），并显示新的访问地址。用户可以直接使用新端口访问应用。

如果需要手动指定端口，可以在 `vite.config.js` 文件中进行配置。通过修改 `server.port` 属性，可以设置自定义端口号。例如，将端口设置为 8080：

```javascript
export default defineConfig({
  server: {
    port: 8080,
    host: true
  }
})
```

此外，使用 Docker 部署时，可以通过 `docker-compose.yml` 文件映射端口。生产环境默认映射到主机的 1645 端口，开发环境映射到 5173 端口。如果这些端口被占用，可以修改 `ports` 配置项以使用其他端口。

**Section sources**
- [vite.config.js](file://vite.config.js#L1-L11)
- [docker-compose.yml](file://docker-compose.yml#L1-L33)

## 依赖安装失败处理

如果在安装项目依赖时遇到问题，可以按照以下步骤进行排查和修复：

1. **清除包管理器缓存**：使用 `pnpm store prune` 命令清除 pnpm 的全局缓存，解决因缓存损坏导致的安装问题。
2. **删除本地依赖文件**：移除 `node_modules` 目录和 `pnpm-lock.yaml` 文件，确保从头开始重新安装所有依赖。
3. **重新安装依赖**：运行 `pnpm install` 命令重新安装所有依赖项。

项目依赖包括 React 18、Vite 构建工具、LZ-String 数据压缩库等。确保 Node.js 版本为 18.0 或更高版本，否则可能导致依赖安装失败或运行时错误。

如果使用 Docker 部署，Dockerfile 中已包含自动安装 pnpm 和依赖的步骤，无需手动干预。但在本地开发时，建议使用 pnpm 包管理器以保证依赖一致性。

**Section sources**
- [package.json](file://package.json#L1-L19)
- [Dockerfile](file://Dockerfile#L1-L36)
- [README.md](file://README.md#L182-L188)

## 构建错误诊断

构建失败可能由多种原因引起，以下是常见的诊断步骤：

1. **检查 Node.js 版本**：确保安装的 Node.js 版本符合要求（18.0 或更高版本）。低版本可能导致构建工具不兼容。
2. **验证依赖完整性**：确认所有依赖已正确安装且版本匹配。可尝试删除 `node_modules` 和 `pnpm-lock.yaml` 后重新安装。
3. **检查代码语法错误**：构建过程中会检测 JavaScript/JSX 语法错误。查看控制台输出的具体错误信息，定位并修复代码中的问题。
4. **清理构建缓存**：Vite 和 pnpm 可能存在缓存问题，可尝试清理缓存后重新构建。

生产构建通过 `pnpm build` 命令执行，产物输出到 `dist` 目录。若构建成功但预览异常，可使用 `pnpm preview` 命令启动本地服务器检查结果。

Docker 构建流程中，Dockerfile 定义了多阶段构建策略，先在 builder 阶段完成依赖安装和构建，再将产物复制到 nginx 镜像中。此过程可避免本地环境差异带来的构建问题。

**Section sources**
- [package.json](file://package.json#L6-L8)
- [Dockerfile](file://Dockerfile#L1-L36)
- [README.md](file://README.md#L190-L196)

## 浏览器兼容性问题

本应用使用现代 Web API，需注意以下兼容性问题：

### Clipboard API 支持

分享功能依赖 Clipboard API 实现复制粘贴操作。现代浏览器（Chrome、Edge、Firefox、Safari）支持该 API，但需满足以下条件：
- 必须通过 HTTPS 协议访问页面（本地开发时 `localhost` 除外）
- 用户需授予剪贴板权限

当 `navigator.clipboard` 不可用时，系统会自动降级使用传统的 `document.execCommand('copy')` 方法。对于无法自动读取剪贴板的情况（如旧版浏览器），提示用户手动粘贴。

错误处理机制会在 `readFromClipboard` 函数中捕获权限拒绝错误（`NotAllowedError` 或 `SecurityError`），并给出明确提示：“剪贴板访问被拒绝。请确保：1) 使用HTTPS访问 2) 浏览器允许剪贴板权限”。

### 其他兼容性注意事项

- 使用 `LZ-String` 库进行数据压缩，兼容所有主流浏览器
- React 18 和 Vite 需要现代 JavaScript 引擎支持
- SVG 渲染在所有现代浏览器中表现一致

**Section sources**
- [src/utils/fretboardShare.js](file://src/utils/fretboardShare.js#L112-L171)
- [README.md](file://README.md#L100-L107)

## 性能优化建议

为提升应用性能，可采取以下优化措施：

### 状态管理优化

使用 React Hooks 管理状态，避免不必要的渲染。`useCallback` 和 `useMemo` 被广泛用于缓存函数和计算值，减少组件重渲染带来的性能开销。例如，在 `Fretboard.jsx` 中，`computeNoteNameMemo` 和 `generateStringPathMemo` 等函数均使用 `useCallback` 进行优化。

### 数据持久化与恢复

应用通过 `localStorage` 持久化保存当前状态和历史记录。每次状态变化时自动保存，页面刷新后可恢复。历史状态最多保留 50 条，避免存储膨胀影响性能。

### 内存与资源优化

- 使用 `requestAnimationFrame` 确保 DOM 更新时机，避免强制同步布局
- 缩略图生成时克隆 SVG 并设置固定尺寸，减少内存占用
- 防抖机制防止频繁保存操作（300ms 内只保存一次）

### 构建与部署优化

Vite 提供了高效的开发服务器和生产构建。生产环境下，代码经过压缩和优化，加载速度快。Docker 部署进一步提升了环境一致性，避免因环境差异导致的性能问题。

**Section sources**
- [src/Fretboard.jsx](file://src/Fretboard.jsx#L110-L117)
- [src/hooks/useFretboardState.js](file://src/hooks/useFretboardState.js#L124-L148)
- [src/utils/fretboardHistory.js](file://src/utils/fretboardHistory.js#L38-L333)
- [src/colorConfig.js](file://src/colorConfig.js#L144-L162)
- [src/components/Toast.jsx](file://src/components/Toast.jsx#L1-L61)