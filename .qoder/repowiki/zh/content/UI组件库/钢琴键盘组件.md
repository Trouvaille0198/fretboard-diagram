# 钢琴键盘组件

<cite>
**本文档引用的文件**  
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx)
- [fretboard.css](file://src/fretboard.css)
- [FretboardMenu.jsx](file://src/components/FretboardMenu.jsx)
- [noteHandlers.js](file://src/handlers/noteHandlers.js)
- [constants.js](file://src/constants.js)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能与实现](#核心功能与实现)
3. [组件属性（Props）](#组件属性props)
4. [布局与渲染机制](#布局与渲染机制)
5. [样式与响应式设计](#样式与响应式设计)
6. [使用示例与联动逻辑](#使用示例与联动逻辑)
7. [可访问性设计](#可访问性设计)
8. [结论](#结论)

## 简介

`PianoKeyboard` 是一个用于音乐理论教学和音符识别的交互式钢琴键盘组件。该组件以可视化方式呈现标准钢琴的一个八度音阶，包含7个白键和5个黑键，支持音符选择、升降号切换和键盘导航。它被集成在指板图生成器中，作为选择根音和切换显示模式的核心工具，帮助用户理解音符在吉他指板上的分布。

该组件通过简洁的DOM结构和CSS定位实现钢琴键的物理布局，利用React状态管理实现交互逻辑，并与应用的其他部分（如调色盘、指板视图）协同工作，提供一致的用户体验。

**Section sources**
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx#L1-L101)
- [FretboardMenu.jsx](file://src/components/FretboardMenu.jsx#L220-L232)

## 核心功能与实现

`PianoKeyboard` 组件的核心功能是提供一个直观的界面，让用户能够通过点击选择音符。其主要实现包括：

- **音符映射**：组件内部定义了白键和黑键的音符索引。白键对应C、D、E、F、G、A、B七个自然音，分别映射到0-11的音符索引上。黑键对应五个变化音（C#/Db, D#/Eb, F#/Gb, G#/Ab, A#/Bb），并记录其在白键序列中的位置，用于计算CSS定位。
- **交互逻辑**：通过 `handleKeyClick` 函数处理点击事件。当用户点击一个琴键时，组件会检查当前选中的音符。如果点击的是已选中的音符，则取消选择（通过传递 `null`）；否则，选择新的音符。这种“点击切换”的模式符合用户直觉。
- **状态管理**：组件本身是无状态的（stateless），其选中状态由父组件（`FretboardMenu`）通过 `selectedNote` prop 传入，并通过 `onNoteSelect` 回调函数通知父组件状态变更，遵循了React单向数据流的原则。

**Section sources**
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx#L5-L37)
- [constants.js](file://src/constants.js#L10-L12)

## 组件属性（Props）

`PianoKeyboard` 组件接收以下三个关键属性，这些属性定义了其行为和外观：

| 属性名 | 类型 | 必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `enharmonic` | number | 是 | 升降号模式。0表示使用升号（♯）表示变化音（如C#），1表示使用降号（♭）表示变化音（如Db）。该值来自应用的全局状态，确保音符显示的一致性。 |
| `selectedNote` | number | 是 | 当前选中的音符索引（0-11）。`null` 表示没有音符被选中。该值决定了哪个琴键显示为“选中”状态。 |
| `onNoteSelect` | function | 是 | 点击琴键时的回调函数。当用户点击一个琴键时，该函数会被调用，并传入被点击音符的索引。如果点击的是已选中的音符，则传入 `null` 以取消选择。 |

这些属性使得 `PianoKeyboard` 成为一个高度可复用的受控组件，其所有状态和行为都由其父组件管理。

**Section sources**
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx#L5-L6)
- [FretboardMenu.jsx](file://src/components/FretboardMenu.jsx#L222-L231)

## 布局与渲染机制

`PianoKeyboard` 的布局设计巧妙地结合了Flexbox和绝对定位，以准确模拟真实钢琴键盘的物理结构。

### 白键布局
白键使用 `display: flex` 进行水平排列。每个白键的CSS样式定义了其固定宽度（45px）、高度（130px）和右边距（2px）。这种布局确保了白键之间有均匀的间隙，同时保持了整体的线性排列。

### 黑键布局
黑键的布局是该组件最复杂的部分。黑键在视觉上是“悬浮”在白键上方的，因此它们使用 `position: absolute` 进行定位。其 `left` 值通过JavaScript动态计算得出。

计算逻辑如下：
1.  **确定参考点**：黑键位于两个白键之间。代码通过 `blackKeys` 数组中的 `position` 字段确定其前一个白键的位置。
2.  **计算中心位置**：计算前一个白键的右边缘和后一个白键的左边缘的中点，这个中点就是黑键的中心。
3.  **计算左边缘**：从黑键的中心位置减去其自身宽度的一半，得到其左边缘的 `left` 值。

```javascript
const prevWhiteKeyLeft = containerPadding + blackKey.position * (whiteKeyWidth + whiteKeyMargin);
const blackKeyCenter = prevWhiteKeyLeft + whiteKeyWidth + whiteKeyMargin / 2;
const leftPosition = blackKeyCenter - blackKeyWidth / 2;
```

这种计算方式确保了黑键始终精确地位于两个白键之间的中心位置，无论屏幕尺寸如何变化。

**Section sources**
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx#L55-L80)
- [fretboard.css](file://src/fretboard.css#L571-L607)

## 样式与响应式设计

组件的样式定义在 `fretboard.css` 文件中，通过CSS类名进行控制，实现了良好的视觉效果和响应式设计。

### 视觉设计
- **白键**：背景为白色，带有轻微的边框和圆角，底部有内边距用于放置音符标签。选中状态时，背景变为浅蓝色（`#d0d0ff`），边框加粗并变为钢蓝色。
- **黑键**：背景为深灰色（`#333`），尺寸较小，位于白键上方。选中状态时，背景变为亮蓝色（`#6b6bff`）。
- **标签**：音符名称使用粗体显示。白键上的标签为深灰色，黑键上的标签为白色，确保了在不同背景下的高对比度。

### 响应式与交互
- **悬停效果**：当鼠标悬停在琴键上时，白键背景变浅（`#f5f5f5`），黑键背景变亮（`#444`），提供视觉反馈。
- **响应式容器**：整个键盘被包裹在 `#piano-keyboard-container` 中，该容器使用 `display: flex` 和 `justify-content: center`，确保键盘在页面上居中显示。键盘本身的高度固定为130px，宽度由白键数量决定，整体布局在不同屏幕尺寸下保持良好。

**Section sources**
- [fretboard.css](file://src/fretboard.css#L551-L640)
- [PianoKeyboard.jsx](file://src/PianoKeyboard.jsx#L39-L96)

## 使用示例与联动逻辑

`PianoKeyboard` 被集成在 `FretboardMenu` 组件中，作为选择根音的主要工具。其使用示例如下：

```jsx
<PianoKeyboard
  enharmonic={enharmonic}
  selectedNote={rootNote}
  onNoteSelect={(noteIndex) => {
    onRootNoteSelect(noteIndex);
    if (noteIndex === null) {
      setDisplayMode('note');
    } else {
      setDisplayMode('solfege');
    }
  }}
/>
```

### 联动逻辑分析
1.  **根音选择**：当用户点击一个琴键时，`onNoteSelect` 回调被触发。首先，它调用 `onRootNoteSelect(noteIndex)`，将选中的音符索引作为新的根音存储在应用状态中。
2.  **显示模式切换**：回调函数接着根据 `noteIndex` 的值决定指板的显示模式：
    -   如果 `noteIndex` 为 `null`（即取消选择根音），则将显示模式切换回“音符模式”（`note`）。
    -   如果 `noteIndex` 为一个有效的音符索引，则将显示模式切换为“唱名模式”（`solfege`）。
3.  **数据更新**：`Fretboard` 组件监听 `rootNote` 和 `displayMode` 的变化，重新计算并渲染指板上的所有音符，将它们显示为对应的唱名（如Do, Re, Mi）。

这种设计将 `PianoKeyboard` 与应用的核心功能紧密耦合，使其成为驱动整个音乐理论教学体验的关键输入设备。

**Section sources**
- [FretboardMenu.jsx](file://src/components/FretboardMenu.jsx#L220-L232)
- [Fretboard.jsx](file://src/Fretboard.jsx#L114-L117)

## 可访问性设计

`PianoKeyboard` 组件在可访问性方面有以下设计和改进空间：

### 已实现的设计
- **键盘事件阻止**：虽然 `PianoKeyboard` 本身没有直接处理键盘事件，但应用的全局键盘处理器（`keyboardHandlers.js`）会阻止某些按键（如 `Backspace`）的默认行为，防止用户在操作时意外导航离开页面。
- **高对比度**：组件使用了高对比度的颜色方案（白键上的深灰文字、黑键上的白色文字），符合WCAG的对比度合规性要求，方便色觉障碍用户识别。

### 改进建议
- **键盘导航**：目前组件主要依赖鼠标点击。为了提升可访问性，可以为每个琴键添加 `tabindex="0"`，使其可被Tab键聚焦，并监听 `Enter` 或 `Space` 键来模拟点击，从而支持完全的键盘操作。
- **ARIA标签**：可以为每个琴键添加 `role="button"` 和 `aria-pressed` 属性，以明确其交互性质和当前的选中状态，帮助屏幕阅读器用户理解界面。

**Section sources**
- [fretboard.css](file://src/fretboard.css#L566-L569)
- [keyboardHandlers.js](file://src/handlers/keyboardHandlers.js#L77-L83)

## 结论

`PianoKeyboard` 组件是一个设计精巧、功能明确的交互式UI元素。它通过精确的CSS定位和清晰的React状态管理，成功地将一个物理钢琴键盘的布局和交互逻辑复刻到了Web界面中。该组件作为指板图生成器的核心输入工具，不仅实现了基本的音符选择功能，还通过与 `FretboardMenu` 和 `Fretboard` 组件的联动，实现了根音选择和显示模式切换的复杂业务逻辑。

其代码结构清晰，关注点分离，是一个可复用的受控组件的良好范例。未来在可访问性方面的改进，如支持键盘导航和ARIA标签，将进一步提升其包容性和用户体验。