# 分享与导入功能指南

## 功能概述

分享与导入功能允许用户将指板状态数据序列化为可分享的字符串，并通过剪贴板进行分享和导入。这使得用户可以轻松地与他人分享自己的指板配置，或者在不同设备间同步状态。

## 使用方法

### 分享指板状态

1. 在"历史状态"画廊中，找到要分享的指板状态缩略图
2. 将鼠标悬停在缩略图上，左上角会出现分享图标按钮（📤）
3. 点击分享按钮
4. 系统会自动将状态数据序列化为字符串并复制到剪贴板
5. 成功后会显示提示消息："分享字符串已复制到剪贴板！"
6. 现在可以将剪贴板中的字符串分享给他人（通过聊天、邮件等方式）

### 导入指板状态

1. 确保剪贴板中已有有效的分享字符串
2. 在"历史状态"画廊的标题栏中，找到"导入"按钮（位于"清空"按钮左侧）
3. 点击"导入"按钮
4. 系统会自动读取剪贴板内容，解析并导入状态
5. 导入成功后，会自动创建新的历史状态并恢复该状态
6. 成功后会显示提示消息："导入成功！"

**注意**：导入功能需要浏览器支持 Clipboard API。如果浏览器不支持，会显示相应的错误提示。

## 数据编码算法

### 算法选择：LZ-String 压缩

本项目使用 **LZ-String** 压缩算法来序列化指板状态数据。选择该算法的原因：

1. **压缩率高**：相比纯 Base64 编码，LZ-String 可以显著减少字符串长度（通常可减少 50-70%）
2. **易于分享**：生成的字符串更短，便于在聊天、邮件等场景中分享
3. **成熟稳定**：LZ-String 是一个经过验证的 JavaScript 压缩库
4. **无需额外配置**：直接使用，无需复杂的配置

### 数据格式

分享字符串的格式为：

```
fretboard://<压缩后的URI编码字符串>
```

其中：
- `fretboard://` 是前缀，用于识别分享字符串
- 后面的字符串是经过 LZ-String 压缩并 URI 编码的 JSON 数据（使用 `compressToEncodedURIComponent`，比 Base64 更短）

### 序列化数据结构

序列化的数据包含以下字段：

```javascript
{
  version: 1,  // 版本号，用于未来扩展和兼容性处理
  state: {
    data: {...},        // notes和connections数据对象
    startFret: 0,       // 起始品（数字）
    endFret: 15,        // 结束品（数字）
    enharmonic: 1,      // 升降号设置（1表示降号，-1表示升号）
    displayMode: 'note', // 显示模式（'note'或'solfege'）
    rootNote: null,     // 根音（数字或null）
    visibility: 'transparent' // 可见性设置
  }
}
```

### 序列化流程

1. **构建数据对象**：将指板状态数据组织成上述格式的对象
2. **JSON序列化**：使用 `JSON.stringify()` 将对象转换为 JSON 字符串
3. **LZ-String压缩**：使用 `LZString.compressToEncodedURIComponent()` 压缩 JSON 字符串（比 Base64 更短）
4. **添加前缀**：在压缩字符串前添加 `fretboard://` 前缀

### 反序列化流程

1. **验证前缀**：检查字符串是否以 `fretboard://` 开头
2. **提取数据**：移除前缀，获取压缩字符串
3. **解压缩**：优先使用 `LZString.decompressFromEncodedURIComponent()` 解压缩，如果失败则尝试 `decompressFromBase64()`（向后兼容）
4. **JSON解析**：使用 `JSON.parse()` 解析 JSON 字符串
5. **版本检查**：验证版本号是否兼容
6. **数据验证**：检查必需字段是否存在且格式正确

## 技术实现细节

### 剪贴板操作

#### 复制到剪贴板

使用两种方法确保兼容性：

1. **现代方法**（优先）：使用 `navigator.clipboard.writeText()` API
2. **降级方案**：使用传统的 `document.execCommand('copy')` 方法

#### 从剪贴板读取

使用两种方法：

1. **现代方法**（优先）：使用 `navigator.clipboard.readText()` API
2. **降级方案**：如果浏览器不支持，会提示用户手动粘贴

**注意**：读取剪贴板需要用户授权，某些浏览器可能会弹出权限请求对话框。

### 错误处理

系统会处理以下错误情况：

- **分享失败**：复制到剪贴板失败时显示错误提示
- **导入失败**：包括以下情况：
  - 剪贴板内容为空或格式不正确
  - 分享字符串格式错误（缺少前缀）
  - 解压缩失败（数据可能已损坏）
  - 版本不兼容
  - 数据格式验证失败
  - 浏览器不支持剪贴板读取

所有错误都会通过 Toast 消息提示用户。

## 使用示例

### 示例 1：分享一个简单的指板状态

1. 用户创建了一个包含几个音符的指板状态
2. 保存状态到历史记录
3. 点击该状态的分享按钮
4. 获得分享字符串（例如）：`fretboard://N4Igrgzgpgwg9gLgA4A...`（实际字符串会更长）
5. 将字符串发送给朋友

### 示例 2：导入分享的状态

1. 朋友收到分享字符串
2. 复制字符串到剪贴板
3. 在指板应用中点击"导入"按钮
4. 系统自动读取剪贴板、解析数据并恢复状态
5. 状态出现在历史记录中，并自动恢复显示

## 版本兼容性

当前版本号为 **1**。如果未来需要修改数据格式，可以通过版本号进行兼容性处理：

- 相同版本：直接解析
- 旧版本：可以尝试转换或提示用户升级
- 新版本：可以提示用户更新应用

## 注意事项

1. **浏览器兼容性**：
   - 现代浏览器（Chrome、Firefox、Edge、Safari 等）都支持 Clipboard API
   - 某些旧版浏览器可能需要使用降级方案

2. **数据大小**：
   - 复杂的指板状态（包含大量音符和连线）生成的字符串会较长
   - 但经过 LZ-String 压缩后，通常仍可控制在合理范围内

3. **安全性**：
   - 分享字符串包含完整的指板状态数据
   - 请确保只与信任的人分享
   - 不要在公共场合分享敏感配置

4. **数据完整性**：
   - 如果分享字符串被修改或损坏，导入时会失败并显示错误提示
   - 建议通过可靠渠道分享（如直接复制粘贴，而非手动输入）

## 未来扩展

可能的改进方向：

1. **URL分享**：将分享字符串编码为 URL 参数，支持通过链接直接导入
2. **二维码生成**：将分享字符串转换为二维码，方便移动设备扫描
3. **版本升级**：支持多版本数据格式的自动转换
4. **部分导入**：允许选择性地导入某些设置（如只导入音符数据，不导入显示设置）
